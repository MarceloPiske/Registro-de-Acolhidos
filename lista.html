<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Pessoas</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="lista.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="root.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
</head>

<body>
    <div class="cabecalho">
        <h2>Lista de Pessoas</h2>
        <h3 id="total-pessoas">Pessoas Contabilizadas: </h3>
        <button id="exportButton">Exportar para Excel</button>
    </div>
    <div id="lista-pessoas"></div>
    <!--  Exportar Excell  -->


    <script>
        // Dados JSON de exemplo
        const jsonData = [
        ];

        // Função para exportar JSON para Excel
        function exportToExcel(jsonData, fileName) {
            const worksheet = XLSX.utils.json_to_sheet(jsonData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, fileName + ".xlsx");
        }

        // Manipulador de evento para o botão de exportação
        document.getElementById("exportButton").addEventListener("click", async function () {
            let data = await get_acolhidos(false)
            if (data.length == 100) {
                let p = await get_acolhidos({ "cont": 100 })
                data = data.concat(p)
            }
            let jsonData = []
            console.log(data);
            for (f of data) {
                jsonData.push({ nome: f.nome_completo, nascimento: converterData(f.data_nascimento.iso) })
            }
            exportToExcel(jsonData, "data");
        });
    </script>
    <script>
        function converterData(data) {
            // Cria um objeto de data a partir da string fornecida
            var dataObj = new Date(data);
            //console.log(dataObj);
            // Extrai os componentes da data
            var dia = dataObj.getDate();
            var mes = dataObj.getMonth() + 1; // Mês é base 0, então adicionamos 1
            var ano = dataObj.getFullYear();

            // Formata os componentes da data para o formato desejado
            var dataFormatada = `${dia < 10 ? '0' : ''}${dia}/${mes < 10 ? '0' : ''}${mes}/${ano}`;

            return dataFormatada;
        }
        // Array de objetos com dados das pessoas
        function get_acolhidos(skip) {
            return new Promise((resolve, reject) => {
                const options = {
                    method: 'GET',
                    headers: {
                        'X-Parse-Application-Id': 'mxMjwUljCNcGI8HGoDfehXkkKxCFclDkhB9quDT7',
                        'X-Parse-REST-API-Key': '6tV6elcdHg1Ycn3F0qlw6Q87B5vEZwJqJEIRxsrg'
                    }
                };
                console.log(skip);
                let params = {}
                if (skip) {
                    params = { "where": `{"deleted": false}`, "skip": skip.cont, "order": "nome_completo" }
                } else {
                    params = { "where": `{"deleted": false}`, "order": "nome_completo" }
                }
                url = new URL('https://parseapi.back4app.com/classes/acolhidos')
                url.search = new URLSearchParams(params).toString();
                fetch(url, options)
                    .then(response => response.json())
                    .then(async response => {
                        //console.log(response.results)
                        resolve(response.results)
                    })
                    .catch(err => console.error(err));
            })
        }

        function delete_acolhido(id) {
            console.log(id);
            const options = {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Parse-Application-Id': 'mxMjwUljCNcGI8HGoDfehXkkKxCFclDkhB9quDT7',
                    'X-Parse-REST-API-Key': '6tV6elcdHg1Ycn3F0qlw6Q87B5vEZwJqJEIRxsrg'
                },
                body: JSON.stringify({ deleted: true })
            };

            fetch('https://parseapi.back4app.com/classes/acolhidos/' + id, options)
                .then(response => response.json())
                .then(response => {
                    console.log(response)
                    location.reload()
                })
                .catch(err => console.error(err));
        }
        // Função para criar e exibir a lista de pessoas
        async function exibirListaPessoas(pessoas) {

            //console.log(pessoas);
            document.getElementById("total-pessoas").innerText = "Pessoas Contabilizadas: " + pessoas.length
            var listaPessoasDiv = document.getElementById("lista-pessoas");

            // Limpa qualquer conteúdo existente na div
            listaPessoasDiv.innerHTML = "";

            // Itera sobre o array de pessoas e cria elementos HTML para exibir seus dados
            pessoas.forEach(function (pessoa) {
                var pessoaDiv = document.createElement("div");
                pessoaDiv.classList.add("pessoa");
                pessoaDiv.id = pessoa.objectId
                //Vizualizar
                let view_button = document.createElement('button')
                view_button.innerHTML = '<span class="material-symbols-sharp">visibility</span>'
                view_button.addEventListener("click", () => {
                    parent.show_modal(pessoa)
                })
                //Editar
                let edit_button = document.createElement('button')
                edit_button.innerHTML = '<span class="material-symbols-sharp">edit</span>'
                edit_button.addEventListener("click", () => {
                    editar_pessoas(pessoa)
                })

                let butts_content = document.createElement("div")
                butts_content.appendChild(edit_button)
                butts_content.appendChild(view_button)

                pessoaDiv.innerHTML = `
                    <div>
                        <h3>${pessoa.nome_completo}</h3>
                    </div>
                `;

                pessoaDiv.appendChild(butts_content)
                listaPessoasDiv.appendChild(pessoaDiv);

            });
        }

        async function inserir_todas_pessoas() {
            var pessoas = await get_acolhidos(false)
           
            if (pessoas.length == 100) {
                let p = await get_acolhidos({ "cont": 100 })
                pessoas = pessoas.concat(p)
            }
            console.log(pessoas.length);
            exibirListaPessoas(pessoas)
        }

        inserir_todas_pessoas()

        function editar_pessoas(pessoa) {
            `
                        <div>
                            <label for="genero">Gênero:</label><br>
                            <input type="radio" id="masculino" name="genero" value="masculino">
                            <label for="masculino">Masculino</label><br>
                            <input type="radio" id="feminino" name="genero" value="feminino">
                            <label for="feminino">Feminino</label>
                        </div>`
            parent.document.getElementById("nome_completo").value = pessoa.nome_completo
            parent.document.getElementById("data_nascimento").value = pessoa.data_nascimento.iso.split("T")[0]

            if (pessoa.genero == "masculino") {
                parent.document.getElementById("masculino").checked = true
            } else {
                parent.document.getElementById("feminino").checked = true
            }

            parent.document.getElementById("cpf").value = pessoa.cpf
            parent.document.getElementById("telefone").value = pessoa.telefone
            
            parent.document.getElementById("rua").value = pessoa.rua
            parent.document.getElementById("numero").value = pessoa.numero
            parent.document.getElementById("complemento").value = pessoa.complemento
            parent.document.getElementById("bairro").value = pessoa.bairro
            parent.document.getElementById("cidade").value = pessoa.cidade
            parent.document.getElementById("alojamento").value = pessoa.alojamento
            
            parent.document.getElementById("situacao_familia").value = pessoa.situacao_familia
            parent.document.getElementById("saude_especiais").value = pessoa.saude_especiais
            parent.document.getElementById("observacao_geral").value = pessoa.observacao_geral

            parent.document.getElementById("editar-pessoa").style.display = "block"
            parent.document.getElementById("criar-pessoa").style.display = "none"

            localStorage.setItem("atual-edit-id", pessoa.objectId)
        }
        // Chama a função para exibir a lista de pessoas ao carregar a página
        //window.onload = exibirListaPessoas;

    </script>

</body>

</html>