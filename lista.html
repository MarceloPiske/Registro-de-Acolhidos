<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Pessoas</title>
    <link rel="stylesheet" href="lista.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="root.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
</head>

<body>
    <h2 id="total-pessoas">Pessoas Contabilizadas: </h2>
    <div id="lista-pessoas"></div>
    <!--  Exportar Excell  -->
    <button id="exportButton">Exportar para Excel</button>

    <script>
        // Dados JSON de exemplo
        const jsonData = [
            { Name: "John", Age: 30, City: "New York" },
            { Name: "Alice", Age: 25, City: "Los Angeles" },
            { Name: "Bob", Age: 35, City: "Chicago" }
        ];

        // Função para exportar JSON para Excel
        function exportToExcel(jsonData, fileName) {
            const worksheet = XLSX.utils.json_to_sheet(jsonData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, fileName + ".xlsx");
        }

        // Manipulador de evento para o botão de exportação
        document.getElementById("exportButton").addEventListener("click", async function () {
            let data = await get_acolhidos()
            let jsonData = []
            console.log(data);
            for ( f of data){
                jsonData.push({nome: f.nome_completo, nascimento: converterData(f.data_nascimento.iso) })
            }
            exportToExcel(jsonData, "data");
        });
    </script>
    <script>
        function converterData(data) {
            // Cria um objeto de data a partir da string fornecida
            var dataObj = new Date(data);

            // Extrai os componentes da data
            var dia = dataObj.getDate();
            var mes = dataObj.getMonth() + 1; // Mês é base 0, então adicionamos 1
            var ano = dataObj.getFullYear();

            // Formata os componentes da data para o formato desejado
            var dataFormatada = `${dia < 10 ? '0' : ''}${dia}/${mes < 10 ? '0' : ''}${mes}/${ano}`;

            return dataFormatada;
        }
        // Array de objetos com dados das pessoas
        function get_acolhidos() {
            return new Promise((resolve, reject) => {
                const options = {
                    method: 'GET',
                    headers: {
                        'X-Parse-Application-Id': 'mxMjwUljCNcGI8HGoDfehXkkKxCFclDkhB9quDT7',
                        'X-Parse-REST-API-Key': '6tV6elcdHg1Ycn3F0qlw6Q87B5vEZwJqJEIRxsrg'
                    }
                };

                let params = { "where": `{"deleted": false}` }
                url = new URL('https://parseapi.back4app.com/classes/acolhidos')
                url.search = new URLSearchParams(params).toString();
                fetch(url, options)
                    .then(response => response.json())
                    .then(response => { resolve(response.results) })
                    .catch(err => console.error(err));
            })
        }

        function delete_acolhido(id) {
            console.log(id);
            const options = {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Parse-Application-Id': 'mxMjwUljCNcGI8HGoDfehXkkKxCFclDkhB9quDT7',
                    'X-Parse-REST-API-Key': '6tV6elcdHg1Ycn3F0qlw6Q87B5vEZwJqJEIRxsrg'
                },
                body: JSON.stringify({ deleted: true })
            };

            fetch('https://parseapi.back4app.com/classes/acolhidos/' + id, options)
                .then(response => response.json())
                .then(response => {
                    console.log(response)
                    location.reload()
                })
                .catch(err => console.error(err));
        }
        // Função para criar e exibir a lista de pessoas
        async function exibirListaPessoas(pessoas) {

            //console.log(pessoas);
            document.getElementById("total-pessoas").innerText = "Pessoas Contabilizadas: " + pessoas.length
            var listaPessoasDiv = document.getElementById("lista-pessoas");

            // Limpa qualquer conteúdo existente na div
            listaPessoasDiv.innerHTML = "";

            // Itera sobre o array de pessoas e cria elementos HTML para exibir seus dados
            pessoas.forEach(function (pessoa) {
                var pessoaDiv = document.createElement("div");
                pessoaDiv.classList.add("pessoa");
                pessoaDiv.id = pessoa.objectId
                pessoaDiv.addEventListener("click", () => {
                    parent.show_modal(pessoa)
                    //parent.document.getElementById("background-modal").style.display = "block"
                })
                pessoaDiv.innerHTML = `
                    <div>
                        <h3>${pessoa.nome_completo}</h3>
                    </div>
                `;

                listaPessoasDiv.appendChild(pessoaDiv);
            });
        }

        async function inserir_todas_pessoas() {
            var pessoas = await get_acolhidos()
            exibirListaPessoas(pessoas)
        }

        inserir_todas_pessoas()
        // Chama a função para exibir a lista de pessoas ao carregar a página
        //window.onload = exibirListaPessoas;
    </script>

</body>

</html>